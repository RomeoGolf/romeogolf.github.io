<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USB-polygon-5: Обмен по USB, поиск устройства</title>
  <!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" href="http://romeogolf.github.io/theme/css/styles.css" type="text/css" />
  <link rel="stylesheet" type="text/css"  href="http://romeogolf.github.io/theme/css/pygments.css"/>
  <link rel="shortcut icon" type="image/png" href="http://romeogolf.github.io/images/RG32.ico" />
  <script language="JavaScript" src="http://romeogolf.github.io/theme/js/protector.js"></script>
</head>
<body>
  <header class="main-header">
    <div>
      <img src="http://romeogolf.github.io/images/72.png" style="margin-left: 34px; margin-top: 30px;"> <a id="name" href=http://romeogolf.github.io id="home-link">RomeoGolf</a>
    </div>
  </header>
    <nav class="nav_base">
      <ul class="main-nav">
          <li class="active"><a href="http://romeogolf.github.io/category/blog.html">Блог</a></li>
          <li><a href="http://romeogolf.github.io/category/tvorchestvo.html">Творчество</a></li>


          <li>
            <a href="http://romeogolf.github.io/pages/triangulum-soft.html">Triangulum Soft</a>
          </li>
          <li>
            <a href="http://romeogolf.github.io/pages/o-saite.html">О сайте</a>
          </li>
      </ul>
    </nav>
  <div class="layout">

    <div class="sidebar">
      <div class="tagcloud">
        Теги:
        <ul class="tagcloud">
          <li class="tag-4">
            <a href="http://romeogolf.github.io/tag/batcmd.html">
              bat/cmd
                <span class="badge">1</span>
            </a>
          </li>
          <li class="tag-2">
            <a href="http://romeogolf.github.io/tag/linux.html">
              linux
                <span class="badge">3</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/markdown.html">
              markdown
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-1">
            <a href="http://romeogolf.github.io/tag/pelican.html">
              pelican
                <span class="badge">6</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/rfquiz.html">
              rfquiz
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-4">
            <a href="http://romeogolf.github.io/tag/tar.html">
              tar
                <span class="badge">1</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/triangulum.html">
              triangulum
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-1">
            <a href="http://romeogolf.github.io/tag/usb-polygon.html">
              usb-polygon
                <span class="badge">14</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/windows.html">
              windows
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/raznoe.html">
              разное
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/remont.html">
              ремонт
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/svoimi-rukami.html">
              своими руками
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-2">
            <a href="http://romeogolf.github.io/tag/stikhi.html">
              стихи
                <span class="badge">3</span>
            </a>
          </li>
        </ul>
      </div> <!-- tagcloud -->
    </div> <!-- sidebar -->

    <div class="content">
  <section class="main-section blog-section" id="blog-posts">
    <h4 class="date">Вт 27 Декабрь 2016</h4>
    <article>
      <h1>USB-polygon-5: Обмен по USB, поиск устройства</h1>
      
      <div class="toc">
<ul>
<li><a href="#_1">Подготовка</a></li>
<li><a href="#_2">Заготовка проекта</a></li>
<li><a href="#_3">Начинаем искать</a></li>
<li><a href="#_4">Запуск и отладка</a></li>
<li><a href="#_5">Коротко о коде</a></li>
</ul>
</div>
<h2 id="_1">Подготовка</h2>
<p>На текущий момент самодельная отладочная плата на контроллере AT90USB162 при подключении к ПК определяется в Windows, как USB MassStorage-устройство, попросту &mdash; флэшка, и даже получает букву диска. Надо каким-то образом начинать обмен реальными данными, не только служебными. Зажечь нужные светодиоды по команде с компьютера, получить на экране число нажатий кнопки на устройстве, что-нибудь подобное для начала.</p>
<p>Можно попробовать заставить плату прикинуться &laquo;настоящим&raquo; устройством с файлами и читать-писать эти &laquo;файлы&raquo; средствами операционной системы. Но это я отложу на попозже. Сперва попробую обмен с физическим устройством, а не с файлами на нем.</p>
<p>Для этого сперва надо подготовить инструмент. Придется писать некоторый код для компьютера. Остановлюсь пока на Windows по ряду причин. Основная причина среди них &mdash; у меня уже есть под рукой кое-какая заготовка, в которой можно подглядеть идеи. Эта заготовка мне не очень нравится, но работает, и на нее можно опираться.</p>
<p>Упомянутая заготовка написана на С++. Опять же, придется использовать API-функции операционной системы, что проще всего делать также на С++: в MSDN расписаны параметры функций и есть примеры, и ориентировано все на С++, а для, скажем, Delphi (или Lazarus) придется переписывать. Полагаю, и примеры на всякого рода форумах тоже проще будет найти на том же С++. А я уже давно на нем ничего приличного не писал, и версию от Microsoft ставить не желаю.</p>
<p>Зато у меня уже есть Eclipse, который используется для Java (в том числе, под Android) и таких проектов на Python, которые сложнее пары скриптовых файлов. Буду в качестве среды разработки использовать его же.</p>
<p>Однако, Eclipse &mdash; это только среда, сам по себе он не будет ничего компилировать. А в качестве компилятора традиционно (хотя и не обязательно) в связке с ним используется GCC. Для Windows этот компилятор (строго говоря &mdash; семейство компиляторов) сам по себе (по крайней мере, пока что) не бывает, а появляется в составе линуксообразного окружения, MinGW или Cygwin. Причем, Cygwin у меня уже имеется, и используется в том числе при работе с этой самоделкой &mdash; выбор и настройка инструментария описана в одном из предыдущих <a href="http://romeogolf.github.io/usb-polygon-3.html">выпусков</a>.</p>
<p>Сделал пробный проектик под С++ и начал как-то с ним упражняться. Угрохал на это дело изрядно времени. Эх, стоило пошагово описывать все подводные камни на этом пути, нехилая лоция бы могла получиться&hellip; Короче, при всем моем уважении к этим продуктам (Eclipse и GCC), настройка их (особенно под Windows) &mdash; это замечательный способ провести долгие зимние вечера, если больше нечем их занять.</p>
<p>Темная тема оформления редактора кода не влияет на тему оформления остальных окон и панелей Eclipse, за них отвечает оконный менеджер, либо надо менять руками отдельно множество строк в конфигурации в разных местах и записывать при этом, что на что менял. Подтянуть настройки, сделанные в рабочем пространстве Java, для рабочего пространства С++ у меня так и не получилось. В настройках проекта надо не забывать добавлять опцию статической линковки некоторых библиотек, иначе не заработает на другой машине. Да и на этой же, впрочем, тоже. Надо не забывать указывать про с++11, чтобы иметь возможность использовать современные фишки языка. И все это и тому подобное вылезало достаточно внезапно и с недостаточно очевидными причинами, просто не знаю, что бы я делал без <a href="http://stackoverflow.com/">StackOverflow</a>.</p>
<p>Наконец, что-то как-то заработало, стали получаться простые консольные приложения. В процессе выяснилось, что GCC в Cygwin и в MinGW имеют заметные отличия &mdash; бинарники библиотек отличаются, заголовочные файлы к этим библиотекам тоже. При попытке компиляции примеров, слизанных с форумов и сделанных в MS Visual Studio, компилятор из MinGW вызывал меньше проблем, так что пришлось устанавливать еще и этот набор софта.</p>
<p>Итак, для написания кода на ПК буду использовать ОС Windows (XP и 7), Eclipse, GCC из состава MinGW. Все это было постепенно установлено и худо-бедно настроено. Не так, чтобы работать было комфортно, но вполне удовлетворительно, а чисто визуальные примочки (типа стилей подсветки синтаксиса или темной цветовой темы) прикручу как-нибудь позже, если будет лишнее время и желание.</p>
<p>Дальше предполагаю такую последовательность действий:</p>
<ul>
<li>Обнаружить подключенные USB-устройства. Как вариант &mdash; сузить поиск до MassStorage-устройств. Поначалу плата-самоделка даже не нужна, хотя что-то типа флэшки желательно подключить. Сойдет и вмонтированный в корпус системника кардридер, который тоже USB-устройство.</li>
<li>Среди подключенных устройств найти свое по какому-либо идентификатору. Тут уже плату надо подключить, но можно ничего в ней не модифицировать.</li>
<li>Открыть это устройство для обмена. То есть, получить его дескриптор, который можно передать функциям Readfile/Writefile. Здесь тоже плата нужна.</li>
<li>Выполнить обмен без ошибок. Вот на этом этапе скорее всего придется что-то править в программе контроллера отладочной платы.</li>
<li>Использовать результаты обмена: считать состояние кнопок, зажечь определенные светодиоды. Тут дописывать программу контроллера придется однозначно, без вариантов.</li>
<li>В процессе решать возникающие проблемы, обеспечивать совместимость хотя бы в двух версиях Windows.</li>
</ul>
<h2 id="_2">Заготовка проекта</h2>
<p>Запускаю Eclipse, создаю новый проект: <code>File -&gt; New -&gt; C++ Project</code>, получаю заготовку исходного кода, выдающего в консоли сакраментальное &laquo;Hello, World!&raquo;. </p>
<p><a href="http://romeogolf.github.io/images/usb-polygon/05/new-prj-cpp.png" title="New Project"><img alt="new-prj" src="http://romeogolf.github.io/images/usb-polygon/05/preview/new-prj-cpp-small.png" title="New Project" /></a></p>
<p>Сразу лезу в настройки проекта, потому что уже в курсе, что собранный код не запустится. <code>Project -&gt; Properties</code>, и в окне <code>Properties for usb-polygon</code> в правой панели выбираю <code>C/C++ Build -&gt; Settings</code>, на вкладке <code>Tool Settings</code> выбираю <code>MinGW C++ Linker -&gt; Miscellaneous</code> и в поле <code>Linker flags</code> вписываю <code>-static-libgcc -static-libstdc++</code>, иначе придется соответствующие библиотеки таскать вместе с проектом. Предпочитаю прилинковать статически.</p>
<p><a href="http://romeogolf.github.io/images/usb-polygon/05/linker-flag.png" title="Подключение библиотек"><img alt="linker-flag" src="http://romeogolf.github.io/images/usb-polygon/05/preview/linker-flag-small.png" title="Подключение библиотек" /></a></p>
<p>Заодно на этой же вкладке выбираю <code>GCC C++ Compiler -&gt; Dialect</code>, и в поле <code>Language standard</code> ставлю <code>ISO C++11 (-srd=c++0x)</code>, пригодится.</p>
<p><a href="http://romeogolf.github.io/images/usb-polygon/05/dialect.png"><img alt="dialect" src="http://romeogolf.github.io/images/usb-polygon/05/preview/dialect-small.png" /></a></p>
<p>Теперь можно и <code>Project -&gt; Build Project</code>, и <code>Run As -&gt; Local C/C++ Application</code>, и в консоли, представленной одним из окошек среды Eclipse, появится то, что просили в тринадцатой строчке автоматически сгенерированного кода, то есть, &laquo;!!!Hello, word!!!&raquo;.</p>
<p>Создаю в папке проекта git-репозиторий и сохраняю это все в виде начального коммита.</p>
<h2 id="_3">Начинаем искать</h2>
<p>Перед тем, как искать устройства USB, подключенные к компьютеру, стоит поискать в интернете, как это делают другие. Вариантов довольно много. Я порылся в форумах, нашел несколько работоспособных решений, остановился на одном, на фундаменте которого начал строить дальше. Код и небольшое обсуждение было обнаружено здесь: <a href="http://programmersforum.ru/showthread.php?t=151603">CyberForum.ru</a></p>
<p>И вот код, который я взял за основу:</p>
<div class="highlight"><pre><span class="cp">#include &lt;windows.h&gt;</span>
<span class="cp">#include &lt;Setupapi.h&gt;</span>
<span class="cp">#include &lt;tchar.h&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>

<span class="kt">void</span> <span class="nf">OutFormatMsg</span><span class="p">(</span><span class="k">const</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">Msg</span><span class="p">){</span>
    <span class="n">LPVOID</span> <span class="n">lpMsgBuf</span><span class="p">;</span>

    <span class="n">FormatMessage</span><span class="p">(</span><span class="n">FORMAT_MESSAGE_ALLOCATE_BUFFER</span> <span class="o">|</span>
        <span class="n">FORMAT_MESSAGE_FROM_SYSTEM</span> <span class="o">|</span>
        <span class="n">FORMAT_MESSAGE_IGNORE_INSERTS</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">GetLastError</span><span class="p">(),</span>
        <span class="n">MAKELANGID</span><span class="p">(</span><span class="n">LANG_NEUTRAL</span><span class="p">,</span> <span class="n">SUBLANG_DEFAULT</span><span class="p">),</span>
        <span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lpMsgBuf</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="nb">NULL</span>
        <span class="p">);</span>

    <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">Msg</span><span class="p">,</span> <span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span><span class="p">)</span><span class="n">lpMsgBuf</span><span class="p">);</span>
    <span class="n">LocalFree</span><span class="p">(</span><span class="n">lpMsgBuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define LocalFreeIf(Pointer) if(Pointer) { LocalFree(Pointer); Pointer = NULL; }</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">setlocale</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

    <span class="n">PSP_DEVICE_INTERFACE_DETAIL_DATA</span> <span class="n">pDeviceInterfaceDetailData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">SP_DEVICE_INTERFACE_DATA</span> <span class="n">DeviceInterfaceData</span><span class="p">;</span>
    <span class="n">SP_DEVINFO_DATA</span> <span class="n">DeviceInfoData</span><span class="p">;</span>
    <span class="n">HDEVINFO</span> <span class="n">hDevInfo</span><span class="p">;</span>
    <span class="n">TCHAR</span> <span class="o">*</span><span class="n">lpBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">GUID</span> <span class="n">InterfaceGuid</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x53F56307</span><span class="p">,</span><span class="mh">0xB6BF</span><span class="p">,</span><span class="mh">0x11D0</span><span class="p">,{</span><span class="mh">0x94</span><span class="p">,</span><span class="mh">0xF2</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xA0</span><span class="p">,</span><span class="mh">0xC9</span><span class="p">,</span><span class="mh">0x1E</span><span class="p">,</span><span class="mh">0xFB</span><span class="p">,</span><span class="mh">0x8B</span><span class="p">}</span> <span class="p">};</span>

    <span class="n">hDevInfo</span> <span class="o">=</span> <span class="n">SetupDiGetClassDevs</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">InterfaceGuid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIGCF_PRESENT</span>  <span class="o">|</span> <span class="n">DIGCF_DEVICEINTERFACE</span>  <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hDevInfo</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OutFormatMsg</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&quot;SetupDiGetClassDevs&quot;</span><span class="p">));</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">DeviceInfoData</span><span class="p">.</span><span class="n">cbSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SP_DEVINFO_DATA</span><span class="p">);</span>
    <span class="n">DeviceInterfaceData</span><span class="p">.</span><span class="n">cbSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SP_DEVICE_INTERFACE_DATA</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">SetupDiEnumDeviceInterfaces</span><span class="p">(</span><span class="n">hDevInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">InterfaceGuid</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DeviceInterfaceData</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ULONG</span> <span class="n">RequiredLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">SetupDiGetDeviceInterfaceDetail</span><span class="p">(</span> <span class="n">hDevInfo</span><span class="p">,</span> 
            <span class="o">&amp;</span><span class="n">DeviceInterfaceData</span><span class="p">,</span> <span class="n">pDeviceInterfaceDetailData</span><span class="p">,</span> <span class="n">RequiredLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequiredLength</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">DeviceInfoData</span> <span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">GetLastError</span><span class="p">()</span> <span class="o">==</span> <span class="n">ERROR_INSUFFICIENT_BUFFER</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">LocalFreeIf</span><span class="p">(</span> <span class="n">pDeviceInterfaceDetailData</span> <span class="p">);</span>
                <span class="n">pDeviceInterfaceDetailData</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSP_DEVICE_INTERFACE_DETAIL_DATA</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LMEM_FIXED</span><span class="p">,</span> <span class="n">RequiredLength</span> <span class="p">);</span>
                <span class="n">pDeviceInterfaceDetailData</span><span class="o">-&gt;</span><span class="n">cbSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SP_DEVICE_INTERFACE_DETAIL_DATA</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">OutFormatMsg</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&quot;SetupDiGetDeviceInterfaceDetail&quot;</span><span class="p">));</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">RequiredLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">SetupDiGetDeviceRegistryProperty</span><span class="p">(</span><span class="n">hDevInfo</span><span class="p">,</span> 
            <span class="o">&amp;</span><span class="n">DeviceInfoData</span><span class="p">,</span> <span class="n">SPDRP_ENUMERATOR_NAME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> 
            <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">lpBuffer</span><span class="p">,</span> <span class="n">RequiredLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequiredLength</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">==</span> <span class="n">ERROR_INSUFFICIENT_BUFFER</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="n">LocalFreeIf</span><span class="p">(</span><span class="n">lpBuffer</span><span class="p">);</span>
                <span class="n">lpBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LPTR</span><span class="p">,</span> <span class="p">(</span><span class="n">RequiredLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">OutFormatMsg</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&quot;SetupDiGetDeviceRegistryProperty&quot;</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">_tcscmp</span><span class="p">(</span><span class="n">lpBuffer</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&quot;USBSTOR&quot;</span><span class="p">))</span> <span class="p">)</span> 
        <span class="p">{</span>
            <span class="c1">// Точно USB накопитель...</span>
            <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">pDeviceInterfaceDetailData</span><span class="o">-&gt;</span><span class="n">DevicePath</span><span class="p">);</span>
            <span class="cm">/* \\?\usbstor#disk&amp;ven_generic&amp;prod_usb_flash_disk&amp;rev_0.00#000000000000ec&amp;0#{53f56307-b6bf-11d0-94f2-00a0c91efb8b} */</span>

            <span class="n">RequiredLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">SetupDiGetDeviceRegistryProperty</span><span class="p">(</span><span class="n">hDevInfo</span><span class="p">,</span> 
                <span class="o">&amp;</span><span class="n">DeviceInfoData</span><span class="p">,</span> <span class="n">SPDRP_FRIENDLYNAME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">lpBuffer</span><span class="p">,</span> <span class="n">RequiredLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequiredLength</span><span class="p">)</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">==</span> <span class="n">ERROR_INSUFFICIENT_BUFFER</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="n">LocalFreeIf</span><span class="p">(</span><span class="n">lpBuffer</span><span class="p">);</span>
                    <span class="n">lpBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span><span class="p">)</span><span class="n">LocalAlloc</span><span class="p">(</span><span class="n">LPTR</span><span class="p">,</span> <span class="p">(</span><span class="n">RequiredLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">OutFormatMsg</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&quot;SetupDiGetDeviceRegistryProperty2&quot;</span><span class="p">));</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span><span class="n">lpBuffer</span><span class="p">);</span>

        <span class="p">}</span>

        <span class="n">LocalFreeIf</span><span class="p">(</span><span class="n">lpBuffer</span><span class="p">);</span>
        <span class="n">LocalFreeIf</span><span class="p">(</span><span class="n">pDeviceInterfaceDetailData</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">SetupDiDestroyDeviceInfoList</span><span class="p">(</span><span class="n">hDevInfo</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h2 id="_4">Запуск и отладка</h2>
<p>Теперь надо заставить этот код заработать в Eclipse.</p>
<p>В файле <code>usb-polygon.cpp</code> убираю автоматически созданный код и вставляю код из форума. Куча красных подчеркиваний. Сохраняю файл. Куча красного исчезает, но Eclipse начинает показывать свой норов: подчеркивает красным <code>_tprintf</code> (&laquo;Function &lsquo;printf&rsquo; could not be resolved&raquo;), хотя <code>tchar.h</code> подключен. Подключаю дополнительно <code>#include &lt;stdio.h&gt;</code>, и Eclipse перестает считать, что это &laquo;not resolved&raquo;. Убираю это подключение &mdash; <code>_tprintf</code> не подчеркивается. Чудеса&hellip; Ладно, оставляю на всякий случай.</p>
<p>Теперь надо разобраться с функциями SetupDi&hellip;, которые считаются неопределенными. Дело в библиотеке SetupAPI, точнее, в ее отсутствии в проекте. Надо добавить в свойства проекта: <code>Project -&gt; Properties</code>, в окне свойств в левой панели выбрать <code>C/C++ Build -&gt; Settings</code>, и на вкладке <code>Tool Settings</code> выбрать <code>MinGW C++ Linker -&gt; Libraries</code>, для <code>Library search path (-L)</code> выбрать в файловой системе <code>C:\MinGW\lib</code>,  а для <code>Libraries (-l)</code> ввести руками <code>setupapi</code>.</p>
<p>Пересобираю проект. Компиляция проходит успешно. Запускаю &mdash; в консоли чисто. Вставляю флэшку, запускаю проект еще раз, получаю (в Windows XP) что-то типа</p>
<div class="highlight"><pre>\\?\usbstor#disk&amp;ven_kingston&amp;prod_dt_101_ii&amp;rev_1.00#001cc05fe930f961715b0183&amp;0#{53f56307-b6bf-11d0-94f2-00a0c91efb8b}
Kingston DT 101 II USB Device
</pre></div>


<p>Пробую воткнуть свою плату и снова запустить программу, в консоли вижу следующее:</p>
<div class="highlight"><pre>\\?\usbstor#disk&amp;ven_lufa&amp;prod_dataflash_disk&amp;rev_0.00#955373038393518170f0&amp;0#{53f56307-b6bf-11d0-94f2-00a0c91efb8b}
LUFA Dataflash Disk USB Device
</pre></div>


<p>Надо сказать, в Windows 7 результат получается такой же, вот только ждать, когда система выделит плате букву диска, приходится долго, да еще и надо каждый раз отказываться от форматирования.</p>
<p>Ну что же, нашли. И код нашли подходящий, и флешку с его помощью тоже нашли, и даже плату свою. Замечательно, начало положено, надо сохранить наработки в git.</p>
<h2 id="_5">Коротко о коде</h2>
<p>Как говорил Козьма Прутков, &laquo;Бросая в воду камешки, смотри на круги, ими образуемые; иначе такое бросание будет пустою забавою&raquo;.</p>
<p>Тупо использовать чужой код &mdash; это очень нехорошо, надо хотя бы разобраться, как он работает. Это не трудно, с учетом того, что предварительно был проведен поиск по MSDN и разного рода литературе и форумам на тему решения задачи. Например, <a href="https://msdn.microsoft.com/ru-ru/library/windows/hardware/ff545011(v=vs.85).aspx">Guidelines for Using SetupAPI</a>, опять же, <a href="https://msdn.microsoft.com/library/windows/hardware/ff553567">Using Device Installation Functions</a>. Я уже и сам подходил к подобному решению, но медленно и некрасиво.</p>
<p><code>OutFormatMsg</code> &mdash; вспомогательная функция для форматированного вывода сообщений об ошибках, если они возникнут.</p>
<p>В теле функции <code>main</code> сперва встречаем <code>SetupDiGetClassDevs</code> &mdash; это функция, возвращающая дескриптор (<code>hDevInfo</code>) набора данных обо всех устройствах указанного класса device setup class или device interface class. Этот Device Information Set &mdash; довольно сложная структура, подробно описанная в MSDN, даже с картинкой.</p>
<p>Класс задается своим глобально уникальным идентификатором <code>InterfaceGuid</code>, который определен чуть выше по коду. Это <code>GUID_DEVINTERFACE_DISK</code>, идентификатор дисковых устройств, но можно попробовать еще <code>GUID_DEVINTERFACE_VOLUME</code>, равный <code>{ 0x53f5630dL, 0xb6bf, 0x11d0, {0x94, 0xf2, 0x00, 0xa0, 0xc9, 0x1e, 0xfb, 0x8b} }</code> и соответствующий томам накопителей.</p>
<p>Далее, <code>SetupDiEnumDeviceInterfaces</code> позволяет перебрать все имеющиеся устройства интересующего класса. Эта функция последовательно (в цикле) выдает информацию в структуре SP_DEVICE_INTERFACE_DATA, и возвращает TRUE до тех пор, пока не закончатся соответствующие устройства.</p>
<p>Чтобы из полученной структуры вытащить детальную информацию об устройстве, используется функция <code>SetupDiGetDeviceInterfaceDetail</code>, возвращающая структуру <code>SP_DEVICE_INTERFACE_DETAIL_DATA</code>, в которой хранится, собственно, только <code>DevicePath</code> &mdash; нуль-терминированная строка, содержащая device interface path, который можно передать в качестве параметра для <code>CreateFile</code>. Вот только работает эта функция довольно ректально: сначала ее нужно вызвать и получить ошибку, зато узнать, сколько места понадобится под упомянутую структуру с деталями, потом вызвать еще раз с полученным размером, чтобы получить саму структуру ради упомянутой строки.</p>
<p><code>SetupDiGetDeviceRegistryProperty</code> поищет в системном реестре и вернет  заданные в параметрах свойства (в нашем случае <code>SPDRP_ENUMERATOR_NAME</code>, то есть имя перечислителя) для указанного устройства. Вызывается тоже через одно место, дважды, первый раз для получения размера.</p>
<p>Далее перечислитель сверяется на наличие подстроки <code>&lt;&lt;USBSTOR&gt;&gt;</code>, чтобы убедиться, что это именно что-то флэшкообразное. Перечислитель (enumerator) &mdash; системный компонент, связанный с однотипными PnP-устройствами. Насколько я понял, именно он отвечает за то, какой драйвер будет вызван для работы с определенным устройством.</p>
<p>Если в процессе последовательного перебора мы (ну, не совсем мы &mdash; система&hellip;) наткнулись на флэшку (<code>USBSTOR</code>), то сначала выдадим с помощью <code>_tprintf</code> ее DevicePath.</p>
<p>Потом еще разок (ну, то есть пару раз) вызовем <code>SetupDiGetDeviceRegistryProperty</code>, но попросим другое свойство &mdash; <code>SPDRP_FRIENDLYNAME</code>, то есть строку с удобочитаемым именем устройства &mdash; и выдадим второй строкой его.</p>
<p>Под конец приберемся за собой: подчистим выделенную память: как строковую (макросом <code>LocalFreeIf</code>), так и выделенную под информацию об устройствах (функцией <code>SetupDiDestroyDeviceInfoList</code>).</p>
<p>Пока что так, расширять буду позже.</p>
      <br/>	
      <footer>
          <div>
            <div>Теги:</div>
            <div class="taglist">
              <ul class="tags">
                <li><a href="http://romeogolf.github.io/tag/usb-polygon.html" class="tag">usb-polygon</a></li>
              </ul>
            </div>
          </div>
        <br/>
        <div class="comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
            var disqus_identifier = "usb-polygon-5.html";
            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = 'http://romeogolf.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
          </script>
          <noscript>
            <div>Для чтения и написания комментариев требуется включить JavaScript.</div>
	  </noscript>
        </div>
      </footer>
    </article>
  </section>
    </div> <!-- content -->
    
  </div> <!-- layout -->

  <div class="footer">
    &copy; 2016 RomeoGolf


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72333148-1', 'auto');
  ga('send', 'pageview');

</script>

<!--    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-72333148-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script> -->
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter35090040 = new Ya.Metrika({
                    id:35090040,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true,
                    webvisor:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/35090040" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </div> <!-- footer -->

</body>
</html>