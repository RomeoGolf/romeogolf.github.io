<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USB-polygon-10: Таблица памяти для имитации ФС</title>
  <!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" href="http://romeogolf.github.io/theme/css/styles.css" type="text/css" />
  <link rel="stylesheet" type="text/css"  href="http://romeogolf.github.io/theme/css/pygments.css"/>
  <link rel="shortcut icon" type="image/png" href="http://romeogolf.github.io/images/RG32.ico" />
  <script language="JavaScript" src="http://romeogolf.github.io/theme/js/protector.js"></script>
</head>
<body>
  <header class="main-header">
    <div>
      <img src="http://romeogolf.github.io/images/72.png" style="margin-left: 34px; margin-top: 30px;"> <a id="name" href=http://romeogolf.github.io id="home-link">RomeoGolf</a>
    </div>
  </header>
    <nav class="nav_base">
      <ul class="main-nav">
          <li class="active"><a href="http://romeogolf.github.io/category/blog.html">Блог</a></li>
          <li><a href="http://romeogolf.github.io/category/tvorchestvo.html">Творчество</a></li>


          <li>
            <a href="http://romeogolf.github.io/pages/triangulum-soft.html">Triangulum Soft</a>
          </li>
          <li>
            <a href="http://romeogolf.github.io/pages/o-saite.html">О сайте</a>
          </li>
      </ul>
    </nav>
  <div class="layout">

    <div class="sidebar">
      <div class="tagcloud">
        Теги:
        <ul class="tagcloud">
          <li class="tag-4">
            <a href="http://romeogolf.github.io/tag/batcmd.html">
              bat/cmd
                <span class="badge">1</span>
            </a>
          </li>
          <li class="tag-2">
            <a href="http://romeogolf.github.io/tag/linux.html">
              linux
                <span class="badge">3</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/markdown.html">
              markdown
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-1">
            <a href="http://romeogolf.github.io/tag/pelican.html">
              pelican
                <span class="badge">6</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/rfquiz.html">
              rfquiz
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-4">
            <a href="http://romeogolf.github.io/tag/tar.html">
              tar
                <span class="badge">1</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/triangulum.html">
              triangulum
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-1">
            <a href="http://romeogolf.github.io/tag/usb-polygon.html">
              usb-polygon
                <span class="badge">9</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/windows.html">
              windows
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/raznoe.html">
              разное
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/remont.html">
              ремонт
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-3">
            <a href="http://romeogolf.github.io/tag/svoimi-rukami.html">
              своими руками
                <span class="badge">2</span>
            </a>
          </li>
          <li class="tag-2">
            <a href="http://romeogolf.github.io/tag/stikhi.html">
              стихи
                <span class="badge">3</span>
            </a>
          </li>
        </ul>
      </div> <!-- tagcloud -->
    </div> <!-- sidebar -->

    <div class="content">
  <section class="main-section blog-section" id="blog-posts">
    <h4 class="date">Ср 24 Май 2017</h4>
    <article>
      <h1>USB-polygon-10: Таблица памяти для имитации ФС</h1>
      
      <div class="toc">
<ul>
<li><a href="#_1">Структура памяти</a></li>
<li><a href="#_2">Главная загрузочная запись устройства</a><ul>
<li><a href="#mbr">Общая структура MBR</a></li>
<li><a href="#_3">Запись раздела</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="_1">Структура памяти</h2>
<p>При имитации файловой системы (<abbr title="файловая система">ФС</abbr>) необходимо отвечать операционной системе на команды чтения и записи. Для этого необходимо знать, что находилось бы по конкретным адресам памяти, если бы память на самом деле была. Следует составить таблицу соответствия данных адресам, эту таблицу будет реализовывать имитатор, отдавая правильные ответы на запрошенные адреса в операциях чтения. Операции записи же поначалу будем игнорировать, делая вид, что все удачно записалось, позже посмотрим, нельзя ли использовать и запись тоже.</p>
<p>Нужна таблица памяти. И даже не одна. Логично представить структуру фиктивной памяти в нескольких таблицах. Первая будет показывать область памяти, не зависящую от используемой <abbr title="файловая система">ФС</abbr> и необходимую любому носителю информации в той или иной форме: <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr>, master boot record. Вторая таблица нужна для описания <abbr title="Partition Boot Record">PBR</abbr>, partition boot record, также не имеющей непосредственного отношения к <abbr title="файловая система">ФС</abbr>. Третья таблица будет описывать таблицу размещения файлов, <abbr title="File Allocation Table, таблица размещения файлов">FAT</abbr> (file allocation table). В оставшейся памяти будет размещаться собственно информация носителя &mdash; папки и файлы. Эту зону можно тоже условно представить в виде примерной таблицы, хотя ее наполнение уже не является жестко фиксированным, в отличие от предыдущих.</p>
<h2 id="_2">Главная загрузочная запись устройства</h2>
<p><abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr> &mdash; запись, которая обязана присутствовать на любом носителе информации, если есть необходимость работать с ним стандартными способами. Есть оговорки. Во-первых, устройство хранения информации (микросхема, карта памяти, USB-носитель) может работать и в &laquo;сыром&raquo; режиме, без файловой системы с постраничной записью и посекторным чтением более-менее стандартными способами &mdash; функциями <abbr title="операционная система">ОС</abbr> вроде ReadFile(). Но это потребует изрядной порции дополнительной работы для обращения к носителю. Во-вторых, сегодня <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr> &mdash; не единственный вариант, например, GPT &mdash; GUID Partition Table. Но в целях имитации флэш-памяти это все неважно, интересует именно <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr>.</p>
<h3 id="mbr">Общая структура <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr></h3>
<p>Таблица 1. Структура <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr></p>
<div class="colortable"></div>
<table>
<thead>
<tr>
<th align="center">Адрес</th>
<th>Описание</th>
<th align="center">Размер, байтов</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">000h</td>
<td>Код загрузчика</td>
<td align="center">446</td>
</tr>
<tr>
<td align="center">1BEh</td>
<td>1. Запись раздела</td>
<td align="center">16</td>
</tr>
<tr>
<td align="center">1CEh</td>
<td>2. Запись раздела</td>
<td align="center">16</td>
</tr>
<tr>
<td align="center">1DEh</td>
<td>3. Запись раздела</td>
<td align="center">16</td>
</tr>
<tr>
<td align="center">1EEh</td>
<td>4. Запись раздела</td>
<td align="center">16</td>
</tr>
<tr>
<td align="center">1FEh</td>
<td>Сигнатура <abbr title="Base Input-Output System, базовая система ввода-вывода">BIOS</abbr> (55h AAh)</td>
<td align="center">2</td>
</tr>
</tbody>
</table>
<p>Код загрузчика (первая строчка таблицы) &mdash; в сущности, программа, которую должен выполнить процессор, если в параметрах <abbr title="Base Input-Output System, базовая система ввода-вывода">BIOS</abbr> указано загружаться с данного устройства. Ему, процессору, предоставляют это устройство для чтения команд и выставляют счетчик команд в ноль. Если он &mdash; процессор &mdash; находит там команды,то начинает их выполнять. В эти 446 байтов можно попытаться запихать весь загрузчик, то есть программу, заставляющую загрузить <abbr title="операционная система">ОС</abbr> в оперативную память и передающую ей управление. Если загрузчик достаточно сложный (типа GRUB или последних версий Windows), то в этот кусочек памяти он не поместится, придется разместить там предзагрузчик, который загрузит основной загрузчик и передаст управление ему.</p>
<p>Однако, все это имеет смысл для носителей информации, которые могут использоваться в качестве загрузочных. К имитируемой флэшке это не относится, поэтому там будут нули.</p>
<p>И это очень хорошо. Нет необходимости хранить в памяти все необходимые записи целиком, из-за чего терялся бы смысл имитации, проще было бы разместить реальные записи в реальной памяти. А так можно не тратить память на хранение нулей, а просто отвечать нулями на адреса от 0 до 1BDh, и такой пустой участок не единственный.</p>
<p>Далее идут записи раздела: набор полей данных, описывающих первичные разделы на носителе информации, четыре штуки. И завершает запись <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr> фиксированная двухбайтовая константа, служащая для сигнализации окончания записи и для проверки ее правильности.</p>
<h3 id="_3">Запись раздела</h3>
<p>Таблица 2. Структура записи раздела</p>
<div class="colortable"></div>
<table>
<thead>
<tr>
<th align="center">Адрес</th>
<th>Описание</th>
<th align="center">Размер, байтов</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">00h</td>
<td>Статус раздела: 0 если неактивный, 80h если активный.</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">01h</td>
<td>Головка, на которой начинается раздел</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">02h</td>
<td>Дорожка, на которой начинается раздел (биты 16-6), и сектор, на котором начинается раздел (биты 5-0).</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">04h</td>
<td>Тип раздела (1h - FAT12, 4h - FAT16&lt;32Мб, 6h - FAT16&gt;32Мб, Bh - FAT32)</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">05h</td>
<td>Головка, на которой заканчивается раздел.</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">06h</td>
<td>Дорожка, на которой заканчивается раздел (биты 16-6), и сектор, на котором заканчивается раздел (биты 5-0).</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">08h</td>
<td>Расстояние между сектором <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr> и первым сектором раздела, в секторах</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">0Ch</td>
<td>Общее число секторов в разделе</td>
<td align="center">4</td>
</tr>
</tbody>
</table>
<p>Адрес в таблице 2 относительный, то есть, от начала записи раздела.</p>
<p>Таких структур первичных разделов может быть 4. Первичный раздел может содержать ряд расширенных разделов. Но, опять же, в рамках проекта USB-polygon это не важно. Здесь вполне достаточно одного раздела, а это значит, что записи разделов 2, 3 и 4 будут заполнены нулями и сэкономят место при имитации.</p>
<p>Таблица 3. Итоговая <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr></p>
<div class="colortable"></div>
<table>
<thead>
<tr>
<th align="center">Адр.</th>
<th>Описание</th>
<th align="center">Разм.</th>
<th align="center">r:c</th>
<th>hex</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">000h</td>
<td>Главная загрузочная запись</td>
<td align="center">446</td>
<td align="center">00:00 .. 27:13</td>
<td>0&hellip;</td>
</tr>
<tr>
<td align="center">1BEh</td>
<td>Статус раздела: 0 если неактивный, 80h если активный</td>
<td align="center">1</td>
<td align="center">27:14</td>
<td>00</td>
</tr>
<tr>
<td align="center">1BFh</td>
<td>Головка, на которой начинается раздел</td>
<td align="center">1</td>
<td align="center">27:15</td>
<td>00</td>
</tr>
<tr>
<td align="center">1C0h</td>
<td>Дорожка, на которой начинается раздел (биты 16-6), и сектор, на котором начинается раздел (биты 5-0).</td>
<td align="center">2</td>
<td align="center">28:00</td>
<td>00 00</td>
</tr>
<tr>
<td align="center">1C2h</td>
<td>Тип раздела (1h - FAT12, 4h - FAT16&lt;32Мб, 6h - FAT16&gt;32Мб, Bh – FAT32, Ch – FAT32 c LBA)</td>
<td align="center">1</td>
<td align="center">28:01</td>
<td>0C</td>
</tr>
<tr>
<td align="center">1C3h</td>
<td>Головка, на которой заканчивается раздел.</td>
<td align="center">1</td>
<td align="center">28:02</td>
<td>00</td>
</tr>
<tr>
<td align="center">1C4h</td>
<td>Дорожка, на которой заканчивается раздел (биты 16-6), и сектор, на котором заканчивается раздел (биты 5-0).</td>
<td align="center">2</td>
<td align="center">28:04</td>
<td>00</td>
</tr>
<tr>
<td align="center">1C6h</td>
<td>Расстояние между сектором <abbr title="Master Boot Record, главная загрузочная запись">MBR</abbr> и первым сектором раздела, в секторах</td>
<td align="center">4</td>
<td align="center">28:06</td>
<td>3E 00 00 00 (62 dec)</td>
</tr>
<tr>
<td align="center">1CAh</td>
<td>Общее число секторов в разделе</td>
<td align="center">4</td>
<td align="center">28:10</td>
<td>B2 04 00 00</td>
</tr>
<tr>
<td align="center">1CEh</td>
<td>2. Запись раздела</td>
<td align="center">16</td>
<td align="center">28:14 .. 29:13</td>
<td>0&hellip;</td>
</tr>
<tr>
<td align="center">1DEh</td>
<td>3. Запись раздела</td>
<td align="center">16</td>
<td align="center">29:14 .. 30:13</td>
<td>0&hellip;</td>
</tr>
<tr>
<td align="center">1EEh</td>
<td>4. Запись раздела</td>
<td align="center">16</td>
<td align="center">30:14 .. 31:13</td>
<td>0&hellip;</td>
</tr>
<tr>
<td align="center">1FEh</td>
<td>Сигнатура <abbr title="Base Input-Output System, базовая система ввода-вывода">BIOS</abbr></td>
<td align="center">2</td>
<td align="center">31:14</td>
<td>55 AA</td>
</tr>
</tbody>
</table>
<ul>
<li>загрузочная запись раздела, хватит одной, хотя можно и четыре</li>
<li>основная таблица <abbr title="File Allocation Table, таблица размещения файлов">FAT</abbr> &mdash; список кластеров, занятых папками и файлами</li>
<li>резервная таблица <abbr title="File Allocation Table, таблица размещения файлов">FAT</abbr></li>
<li>файловая запись, соответствующая корневому каталогу</li>
<li>прочие файловые записи, по обстоятельствам (фиктивные файлы, а при желании &mdash; и фиктивные папки)</li>
</ul>
      <br/>	
      <footer>
          <div>
            <div>Теги:</div>
            <div class="taglist">
              <ul class="tags">
                <li><a href="http://romeogolf.github.io/tag/usb-polygon.html" class="tag">usb-polygon</a></li>
              </ul>
            </div>
          </div>
        <br/>
        <div class="comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
            var disqus_identifier = "drafts/usb-polygon-10.html";
            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = 'http://romeogolf.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
          </script>
          <noscript>
            <div>Для чтения и написания комментариев требуется включить JavaScript.</div>
	  </noscript>
        </div>
      </footer>
    </article>
  </section>
    </div> <!-- content -->
    
  </div> <!-- layout -->

  <div class="footer">
    &copy; 2016 RomeoGolf


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72333148-1', 'auto');
  ga('send', 'pageview');

</script>

<!--    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-72333148-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script> -->
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter35090040 = new Ya.Metrika({
                    id:35090040,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true,
                    webvisor:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/35090040" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
  </div> <!-- footer -->

</body>
</html>